<!doctype html>
<html lang="uk">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>SlateClock</title>
  <style>
    :root {
      --bg: #000;
      --fg: #fff;
      --accent: #ff4444;
      --hud-dim: rgba(255,255,255,0.07);
    }
    html, body {
      margin:0; padding:0; height:100%; background:var(--bg); color:var(--fg);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, "Helvetica Neue", Arial, "Noto Sans", "Liberation Sans", sans-serif;
      cursor: none;
    }
    .root {
      position: relative; width:100%; height:100%;
      display:flex; align-items:center; justify-content:center; overflow:hidden;
    }
    /* Тех-строка */
    .note {
      position:absolute; bottom:2.5vmin; left:50%; transform:translateX(-50%);
      font-weight:800; font-size:min(8vmin, 72px); letter-spacing:0.02em; white-space:nowrap;
      background: transparent;
      text-shadow: 0 0 12px rgba(0,0,0,.35);
      user-select: none;
    }
    /* HUD рамка (опціонально) */
    .hud {
      position:absolute; inset:3vmin; border:2px solid var(--hud-dim); border-radius:2vmin;
      pointer-events:none;
    }
    /* Шторки */
    .shutter {
      position:absolute; left:0; right:0; height:50%; background:#000; z-index: 999;
      transform: translateY(0);
    }
    .shutter.top { top:0; transform: translateY(-100%); }
    .shutter.bot { bottom:0; transform: translateY(100%); }
    .shutter.active.top { transform: translateY(0); }
    .shutter.active.bot { transform: translateY(0); }

    /* COUNTDOWN overlay */
    #countdownOverlay {
      position: fixed; inset: 0; z-index: 2000; display: none;
      align-items: center; justify-content: center;
      background: #c00000; /* червоне тло */
      color: #ffffff;       /* білі цифри */
    }
    #countdownText {
      font-size: min(35vw, 35vh);
      line-height: 1; font-weight: 900; letter-spacing: .02em;
      text-align: center; user-select: none;
      text-shadow: 0 0 18px rgba(0,0,0,.4);
    }
    /* Центральний великий годинник — як заповнювач (можеш змінити) */
    .clock {
      font-size: min(20vmin, 160px); font-weight:900; letter-spacing:.03em; user-select:none;
      text-shadow: 0 0 18px rgba(0,0,0,.4);
    }
  </style>
</head>
<body>
  <div class="root" id="root">
    <!-- Шторки -->
    <div class="shutter top" id="shTop"></div>
    <div class="shutter bot" id="shBot"></div>

    <!-- Основний контент -->
    <div class="clock" id="clock">--:--:--</div>
    <div class="note" id="note">—</div>
    <div class="hud" id="hud"></div>
  </div>

  <!-- COUNTDOWN overlay -->
  <div id="countdownOverlay">
    <div id="countdownText">5</div>
  </div>

  <script>
    // ===== URL params =====
    const url = new URL(location.href);
    const wsParam   = url.searchParams.get('ws');
    const autoFs    = url.searchParams.get('autofs') === '1';
    const noHud     = url.searchParams.get('nohud')  === '1';
    const showCursor= url.searchParams.get('cursor') === '1';

    if (showCursor) document.documentElement.style.cursor = 'auto';
    if (noHud)      document.getElementById('hud').style.display = 'none';

    // ===== Fullscreen (опція) =====
    async function goFullscreen() {
      if (document.fullscreenElement) return;
      try {
        await document.documentElement.requestFullscreen();
      } catch {}
    }
    if (autoFs) {
      // намагаємось одразу; якщо браузер блокує — увімкнеться при першому keydown
      goFullscreen();
      window.addEventListener('keydown', ()=>goFullscreen(), { once:true });
      window.addEventListener('pointerdown', ()=>goFullscreen(), { once:true });
    }

    // ===== Годинник локальний (можеш замінити на серверний час, якщо треба) =====
    const clockEl = document.getElementById('clock');
    function tick() {
      const d = new Date();
      const hh = String(d.getHours()).padStart(2,'0');
      const mm = String(d.getMinutes()).padStart(2,'0');
      const ss = String(d.getSeconds()).padStart(2,'0');
      clockEl.textContent = `${hh}:${mm}:${ss}`;
    }
    setInterval(tick, 200);
    tick();

    // ===== Шторки =====
    let shutterCfg = { ease:false, duration:600 };
    const shTop = document.getElementById('shTop');
    const shBot = document.getElementById('shBot');

    function applyShutterTransition() {
      const t = shutterCfg.duration || 600;
      const easing = shutterCfg.ease ? 'cubic-bezier(.22,.61,.36,1)' : 'linear';
      shTop.style.transition = `transform ${t}ms ${easing}`;
      shBot.style.transition = `transform ${t}ms ${easing}`;
    }
    applyShutterTransition();

    function blinkShutters() {
      shTop.classList.add('active');
      shBot.classList.add('active');
      setTimeout(()=>{
        shTop.classList.remove('active');
        shBot.classList.remove('active');
      }, (shutterCfg.duration || 600) + 30);
    }

    // SPACE — блимнути
    window.addEventListener('keydown', (e)=>{
      if (e.code === 'Space') {
        e.preventDefault();
        blinkShutters();
      }
    });

    // ===== Тех-строка =====
    const noteEl = document.getElementById('note');

    // ===== WebSocket =====
    function makeDefaultWsUrl() {
      const proto = location.protocol === 'https:' ? 'wss:' : 'ws:';
      return proto + '//' + location.host;
    }
    const wsUrl = wsParam || makeDefaultWsUrl();
    const ws = new WebSocket(wsUrl);

    ws.addEventListener('open', ()=>{/* ok */});
    ws.addEventListener('error', ()=>{/* silent */});

    ws.addEventListener('message', (ev)=>{
      let msg;
      try { msg = JSON.parse(ev.data); } catch { return; }
      if (!msg || typeof msg !== 'object') return;

      if (msg.type === 'note') {
        noteEl.textContent = msg.note || '—';
      }
      else if (msg.type === 'config' && msg.config) {
        shutterCfg = {
          ease: !!msg.config.ease,
          duration: Number(msg.config.duration) || 600
        };
        applyShutterTransition();
      }
      else if (msg.type === 'blink') {
        blinkShutters();
      }
      else if (msg.type === 'countdown') {
        const start = Number(msg.start) || 5;
        const final = (msg.final ?? 'GO!').toString();
        startCountdown(start, final);
      }
    });

    // ===== COUNTDOWN =====
    let countdownTimer = null;
    let finalTimer = null;
    const cdOverlay = document.getElementById('countdownOverlay');
    const cdText    = document.getElementById('countdownText');

    function clearCountdownTimers() {
      if (countdownTimer) { clearInterval(countdownTimer); countdownTimer = null; }
      if (finalTimer)     { clearTimeout(finalTimer);     finalTimer = null; }
    }

    function startCountdown(start, finalText) {
      clearCountdownTimers();

      let n = parseInt(start, 10);
      if (!Number.isFinite(n) || n < 1) n = 5;

      // Початок: червоне тло, білі цифри
      cdOverlay.style.display = 'flex';
      cdOverlay.style.background = '#c00000';
      cdOverlay.style.color = '#ffffff';
      cdText.style.color = '#ffffff';
      cdText.textContent = n;

      countdownTimer = setInterval(()=>{
        n--;
        if (n > 0) {
          cdText.textContent = n;
        } else {
          clearInterval(countdownTimer); countdownTimer = null;
          // Фінальна фраза 3 сек: зелене тло з червоним текстом
          cdOverlay.style.background = '#0ea800';
          cdText.style.color = '#c00000';
          cdText.textContent = (finalText || 'GO!').toString();
          finalTimer = setTimeout(()=>{
            cdOverlay.style.display = 'none';
            clearCountdownTimers();
          }, 3000);
        }
      }, 1000);
    }
  </script>
</body>
</html>
